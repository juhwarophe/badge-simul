<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë±ƒì§€ ì‹œë®¬ë ˆì´í„°</title>
<style>
  body {
    font-family: Pretendard, sans-serif;
    background: #121212;
    color: #eee;
    text-align: center;
    padding: 20px;
    margin: 0;
  }
  h1 { color: #ffcc00; margin-top: 12px; }
  .btn, .smallBtn {
    cursor: pointer;
    border: none;
    border-radius: 10px;
    font-weight: bold;
    transition: 0.2s;
  }
  .btn {
    padding: 10px 20px;
    background: #ffcc00;
    margin-top: 20px;
  }
  .btn:hover { background: #ffdd33; }
  .smallBtn {
    margin-top: 16px;
    padding: 8px 14px;
    background: #444;
    color: #fff;
  }
  .smallBtn:hover { background: #666; }
  .option {
    margin: 8px auto;
    width: 60%;
    padding: 10px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.25s ease;
    color: #000;
    opacity: 0;
    transform: translateY(10px);
    animation: slideIn 0.3s ease-out forwards;
    animation-delay: calc(var(--index) * 0.05s);
  }
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .option:hover { filter: brightness(1.1); }
  .locked { border: 2px solid #fff; }
  #mainScreen, #underConstruction {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    height: calc(100vh - 40px);
  }
  .mainImage {
    width: 150px;
    height: 150px;
    border-radius: 20px;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    transition: 0.2s;
    background: #333;
    position: relative;
    pointer-events: auto;
  }
  .mainImage:hover { filter: brightness(1.2); }
  .mainImage img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  .mainImage .fallback {
    color: #ddd;
    font-size: 14px;
    display: none;
  }
  .mainImage img:not([src]) + .fallback {
    display: block;
  }
  #simulatorScreen, #simulator80Screen {
    display: none;
    padding: 24px;
    min-height: calc(100vh - 40px);
  }
  #underConstruction {
    display: none;
    flex-direction: column;
    color: #ffcc00;
    font-size: 24px;
  }
  .rollCountDisplay {
    margin-top: 10px;
    font-size: 18px;
    color: #aaa;
  }
  #resetBtn, #resetBtn80 {
    margin-left: 8px;
    padding: 6px 12px;
    font-size: 14px;
    border-radius: 6px;
    background: #333;
    color: #ffcc00;
    border: 1px solid #ffcc00;
    cursor: pointer;
  }
  #resetBtn:hover, #resetBtn80:hover { background: #444; }
  #toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #ff4444;
    color: #fff;
    padding: 10px 20px;
    border-radius: 5px;
    display: none;
    z-index: 1000;
  }
  @media (max-width: 600px) {
    .option { width: 90%; }
    .mainImage { width: 100px; height: 100px; }
  }
</style>
</head>
<body>
<!-- ë©”ì¸ í™”ë©´ -->
<div id="mainScreen">
  <div class="mainImage" id="leftImage" title="70LV ì‹œë®¬ë ˆì´í„°ë¡œ ì´ë™" tabindex="0">
    <img src="https://i.ifh.cc/NotKyl.png" alt="70LV ì‹œë®¬ë ˆì´í„°">
    <div class="fallback">70lv ì‹œë®¬ë ˆì´í„°</div>
  </div>
  <div class="mainImage" id="midImage" title="80LV ì‹œë®¬ë ˆì´í„°" tabindex="0">
    <img src="https://i.ifh.cc/HgXLM7.png" alt="80LV ì‹œë®¬ë ˆì´í„°">
    <div class="fallback">80lv ì‹œë®¬ë ˆì´í„°</div>
  </div>
  <div class="mainImage" id="rightImage" title="ì¤€ë¹„ì¤‘" tabindex="0">
    <div style="color: #ddd; font-size: 14px;">(ì¤€ë¹„ì¤‘)</div>
  </div>
</div>
<!-- ì¤€ë¹„ì¤‘ í™”ë©´ -->
<div id="underConstruction">
  <div>ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤</div>
  <button class="smallBtn" onclick="backToMain()" tabindex="0">ë©”ì¸ìœ¼ë¡œ</button>
</div>
<!-- 70LV ë±ƒì§€ ì‹œë®¬ë ˆì´í„° -->
<div id="simulatorScreen">
  <h1>70LV ë±ƒì§€ ì‹œë®¬ë ˆì´í„°</h1>
  <div class="rollCountDisplay">
    ğŸ² ì‹œë®¬ë ˆì´ì…˜ íšŸìˆ˜: <span id="rollCount">0</span>íšŒ
    <button id="resetBtn" onclick="resetSimulation('simulator')" tabindex="0">ë¦¬ì…‹</button>
  </div>
  <label>
    <input type="checkbox" id="useRefine"> ì—°ë§ˆì œ ì‚¬ìš© (ìµœëŒ€ 2ê°œ ì˜µì…˜ ì ê¸ˆ ê°€ëŠ¥)
  </label>
  <button class="btn" onclick="backToMain()" tabindex="0">ë©”ì¸ í™”ë©´ìœ¼ë¡œ</button>
  <div id="optionsContainer"></div>
  <button class="btn" id="rollBtn" onclick="rollOptions('simulator')" tabindex="0">ì˜µì…˜ êµ´ë¦¬ê¸°</button>
</div>
<!-- 80LV ë±ƒì§€ ì‹œë®¬ë ˆì´í„° -->
<div id="simulator80Screen">
  <h1>80LV ë±ƒì§€ ì‹œë®¬ë ˆì´í„°</h1>
  <div class="rollCountDisplay">
    ğŸ² ì‹œë®¬ë ˆì´ì…˜ íšŸìˆ˜: <span id="rollCount80">0</span>íšŒ
    <button id="resetBtn80" onclick="resetSimulation('simulator80')" tabindex="0">ë¦¬ì…‹</button>
  </div>
  <label>
    <input type="checkbox" id="useRefine80"> ì—°ë§ˆì œ ì‚¬ìš© (ìµœëŒ€ 2ê°œ ì˜µì…˜ ì ê¸ˆ ê°€ëŠ¥)
  </label>
  <button class="btn" onclick="backToMain()" tabindex="0">ë©”ì¸ í™”ë©´ìœ¼ë¡œ</button>
  <div id="options80Container"></div>
  <button class="btn" id="rollBtn80" onclick="rollOptions('simulator80')" tabindex="0">ì˜µì…˜ êµ´ë¦¬ê¸°</button>
</div>
<div id="toast"></div>
<script>
/* ================= í™”ë©´ ì „í™˜ ================= */
const mainScreen = document.getElementById("mainScreen");
const simulatorScreen = document.getElementById("simulatorScreen");
const simulator80Screen = document.getElementById("simulator80Screen");
const underConstruction = document.getElementById("underConstruction");

function show(target) {
  console.log(`Switching to screen: ${target.id}`);
  [mainScreen, simulatorScreen, simulator80Screen, underConstruction].forEach(div => div.style.display = "none");
  if (target === mainScreen || target === underConstruction) {
    target.style.display = "flex";
  } else {
    target.style.display = "block";
  }
}

function backToMain() {
  console.log("Returning to main screen");
  show(mainScreen);
}

/* ================= ë°ì´í„° ì •ì˜ ================= */
const groups = [
  { weight: 26.6667, options: [
    ["ì²´ë ¥", [680, 850, 1020]],
    ["ê³µê²©ë ¥", [70, 88, 105]],
    ["ë°©ì–´ë ¥", [35, 44, 53]],
    ["ì²´ë ¥", ["4%", "5%", "6%", "12%"]],
    ["ê³µê²©ë ¥", ["4%", "5%", "6%", "12%"]],
    ["ë°©ì–´ë ¥", ["10%", "12.5%", "15%"]]
  ]},
  { weight: 24.5778, options: [
    ["ì¼ë°˜ ê³µê²© ì¹˜ëª…íƒ€ìœ¨", ["5%", "6.3%", "7.5%"]],
    ["ìŠ¤í‚¬ ì¹˜ëª…íƒ€ìœ¨", ["5%", "6.3%", "7.5%"]],
    ["í•„ì‚´ê¸° ì¹˜ëª…íƒ€ìœ¨", ["5%", "6.3%", "7.5%"]],
    ["í‘œì‹ ì¹˜ëª…íƒ€ìœ¨", ["5%", "6.3%", "7.5%"]],
    ["ì†Œí™˜ë¬¼ ì¹˜ëª…íƒ€ìœ¨", ["5%", "6.3%", "7.5%"]],
    ["íŒŒìƒë¬¼ ì¹˜ëª…íƒ€ìœ¨", ["5%", "6.3%", "7.5%"]]
  ]},
  { weight: 30.5333, options: [
    ["ì¹˜ëª…íƒ€ í”¼í•´", ["8%", "10%", "12%"]],
    ["ì†ì„± í”¼í•´", ["4%", "5%", "6%", "12%"]],
    ["ì¼ë°˜ê³µê²© í”¼í•´", ["10%", "12.5%", "15%", "30%"]],
    ["ìŠ¤í‚¬ í”¼í•´", ["7%", "8%", "10%", "20%"]],
    ["í•„ì‚´ê¸° í”¼í•´", ["10%", "13%", "15%", "30%"]],
    ["í‘œì‹ í”¼í•´", ["27%", "33%", "40%", "80%"]],
    ["ì†Œí™˜ë¬¼ í”¼í•´", ["7%", "8%", "10%", "20%"]],
    ["íŒŒìƒë¬¼ í”¼í•´", ["7%", "8%", "10%", "20%"]],
    ["ì¹˜ëª…íƒ€ìœ¨", ["5%", "6.3%", "7.5%", "15%"]]
  ]},
  { weight: 7.1111, options: [
    ["ì†ì„± ê´€í†µ", [35, 40, 53, 110]],
    ["ë©”ì¸ SP", ["10%", "12.5%", "15%", "30%"]],
    ["ì§€ì› SP", ["13.5", "17", "20.3", "40%"]]
  ]},
  { weight: 11.1111, options: [
    ["ì¼ë°˜ ê³µê²© ë ˆë²¨ì—…", ["+1", "+2", "+3"]],
    ["ìŠ¤í‚¬ ë ˆë²¨ì—…", ["+1", "+2", "+3"]],
    ["ì§€ì› ìŠ¤í‚¬ ë ˆë²¨ì—…", ["+1", "+2", "+3"]],
    ["í•„ì‚´ê¸° ë ˆë²¨ì—…", ["+1", "+2", "+3"]]
  ]}
];
const tierWeights = [40, 35, 15, 10];
const colors = ["#66ff66", "#33ccff", "#ffdd33"];
const rainbow = "linear-gradient(90deg, #ff9a9e, #fad0c4, #fbc2eb, #a1c4fd, #c2e9fb)";

const simulators = {
  simulator: {
    optionsContainer: document.getElementById("optionsContainer"),
    useRefine: document.getElementById("useRefine"),
    lockedOptions: new Set(),
    optionValues: [],
    rollCount: 0,
    rollCountElement: document.getElementById("rollCount")
  },
  simulator80: {
    optionsContainer: document.getElementById("options80Container"),
    useRefine: document.getElementById("useRefine80"),
    lockedOptions: new Set(),
    optionValues: [],
    rollCount: 0,
    rollCountElement: document.getElementById("rollCount80")
  }
};

/* ================= ìœ í‹¸ ================= */
function randomByWeight(weights) {
  const total = weights.reduce((a, b) => a + b, 0);
  let r = Math.random() * total;
  for (let i = 0; i < weights.length; i++) {
    if (r < weights[i]) return i;
    r -= weights[i];
  }
  return weights.length - 1;
}

function pickGroup(is80lv) {
  const availableGroups = is80lv ? groups : groups.slice(0, -1); // 70lvëŠ” ë ˆë²¨ì—… ê·¸ë£¹(4) ì œì™¸
  return availableGroups[randomByWeight(availableGroups.map(g => g.weight))];
}

/* ================= ì˜µì…˜ ìƒì„± ================= */
function pickUniqueOptions(excludeNames = [], is80lv = false) {
  const used = new Set(excludeNames);
  const result = [];
  let maxAttempts = 100;

  while (result.length + excludeNames.length < 4 && maxAttempts > 0) {
    const group = pickGroup(is80lv);
    const available = group.options.filter(o => !used.has(o[0]));
    if (!available.length) {
      maxAttempts--;
      continue;
    }
    let [name, values] = available[Math.floor(Math.random() * available.length)];
    if (name.includes("ë ˆë²¨ì—…")) {
      if (!is80lv) continue; // 70lvì—ì„œëŠ” ë ˆë²¨ì—… ì˜µì…˜ ê±´ë„ˆëœ€
      const roll = Math.random();
      if (roll < 0.4) {
        result.push({ name, value: "+1", tier: 3, maxTier: 3 });
      } else {
        const tier4Roll = Math.random();
        if (tier4Roll < 0.75) {
          result.push({ name, value: "+2", tier: 4, maxTier: 4 });
        } else {
          result.push({ name, value: "+3", tier: 4, maxTier: 4 });
        }
      }
    } else {
      const tier = Math.min(randomByWeight(tierWeights), values.length - 1) + 1;
      const index = Math.min(tier - 1, values.length - 1);
      result.push({ name, value: values[index], tier: tier, maxTier: values.length });
    }
    used.add(name);
    maxAttempts--;
  }

  if (result.length + excludeNames.length < 4) {
    console.warn("Not enough unique options, returning default");
    while (result.length + excludeNames.length < 4) {
      result.push({ name: "ê¸°ë³¸ ì˜µì…˜", value: "0", tier: 1, maxTier: 1 });
    }
  }
  return result;
}

/* ================= ë Œë”ë§ ================= */
function renderOptions(screen, withAnim = false) {
  const sim = simulators[screen];
  sim.optionsContainer.innerHTML = "";
  sim.optionValues.forEach((opt, i) => {
    const e = document.createElement("div");
    e.textContent = `${opt.name} ${opt.value}`;
    e.className = "option";
    e.setAttribute("tabindex", "0");
    if (sim.lockedOptions.has(i)) e.classList.add("locked");
    if (opt.tier === 4 || (opt.name.includes("ë ˆë²¨ì—…") && opt.value !== "+1")) {
      console.log(`Rainbow option: ${opt.name} ${opt.value} (tier ${opt.tier})`);
      e.style.background = rainbow;
      e.style.color = "#fff";
      e.style.textShadow = "0 0 3px #000";
    } else {
      e.style.background = colors[opt.tier - 1];
      e.style.color = "#000";
    }
    if (withAnim && !sim.lockedOptions.has(i)) {
      e.style.setProperty("--index", i);
    } else {
      e.style.opacity = "1";
      e.style.transform = "translateY(0)";
      e.style.animation = "none"; // ì• ë‹ˆë©”ì´ì…˜ ê°•ì œ ë¹„í™œì„±í™”
    }
    sim.optionsContainer.appendChild(e);
  });
}

/* ================= ì‹œë®¬ ================= */
function rollOptions(screen) {
  const sim = simulators[screen];
  const lockedNames = [...sim.lockedOptions].map(i => sim.optionValues[i].name);
  const newValues = pickUniqueOptions(lockedNames, screen === "simulator80");
  let n = 0;
  sim.optionValues = sim.optionValues.map((opt, i) => sim.lockedOptions.has(i) ? opt : newValues[n++]);
  sim.rollCount++;
  sim.rollCountElement.textContent = sim.rollCount;
  renderOptions(screen, true);
}

function resetSimulation(screen) {
  if (!confirm("ì‹œë®¬ë ˆì´ì…˜ì„ ì´ˆê¸°í™”í• ê¹Œìš”?")) return;
  const sim = simulators[screen];
  sim.rollCount = 0;
  sim.lockedOptions.clear();
  sim.optionValues = pickUniqueOptions([], screen === "simulator80");
  sim.rollCountElement.textContent = "0";
  renderOptions(screen);
}

function toggleLock(i, screen) {
  const sim = simulators[screen];
  if (!sim.useRefine.checked) return;
  if (sim.lockedOptions.has(i)) {
    sim.lockedOptions.delete(i);
  } else if (sim.lockedOptions.size >= 2) {
    showToast("ìµœëŒ€ 2ê°œê¹Œì§€ë§Œ ì ê¸€ ìˆ˜ ìˆìŠµë‹ˆë‹¤!");
    return;
  } else {
    sim.lockedOptions.add(i);
  }
  renderOptions(screen, false);
}

function showToast(message) {
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.style.display = "block";
  setTimeout(() => {
    toast.style.display = "none";
  }, 2000);
}

/* ================= ì´ë²¤íŠ¸ ìœ„ì„ ================= */
function handleOptionClick(e, screen) {
  if (!e.target.classList.contains("option")) return;
  const index = Array.from(e.target.parentNode.children).indexOf(e.target);
  toggleLock(index, screen);
}

simulators.simulator.optionsContainer.addEventListener("click", (e) => handleOptionClick(e, "simulator"));
simulators.simulator80.optionsContainer.addEventListener("click", (e) => handleOptionClick(e, "simulator80"));

// í‚¤ë³´ë“œ ì ‘ê·¼ì„±
[simulators.simulator.optionsContainer, simulators.simulator80.optionsContainer].forEach(container => {
  container.addEventListener("keydown", (e) => {
    if (e.target.classList.contains("option") && e.key === "Enter") {
      e.target.click();
    }
  });
});

/* ================= ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë°”ì¸ë”© ================= */
document.addEventListener("DOMContentLoaded", () => {
  console.log("DOM fully loaded, binding events");
  const leftImage = document.getElementById("leftImage");
  const midImage = document.getElementById("midImage");
  const rightImage = document.getElementById("rightImage");

  if (!leftImage || !midImage || !rightImage) {
    console.error("One or more main image elements not found");
    showToast("í™”ë©´ ë¡œë“œ ì˜¤ë¥˜, ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”");
    return;
  }

  leftImage.addEventListener("click", () => {
    console.log("70lv simulator clicked");
    show(simulatorScreen);
    renderOptions("simulator", false); // ì• ë‹ˆë©”ì´ì…˜ ë¹„í™œì„±í™”
  });
  midImage.addEventListener("click", () => {
    console.log("80lv simulator clicked");
    show(simulator80Screen);
    renderOptions("simulator80", false); // ì• ë‹ˆë©”ì´ì…˜ ë¹„í™œì„±í™”
  });
  rightImage.addEventListener("click", () => {
    console.log("Under construction clicked");
    show(underConstruction);
  });

  [leftImage, midImage, rightImage].forEach(img => {
    img.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        console.log(`${img.id} enter key pressed`);
        img.click();
      }
    });
  });

  // ì´ˆê¸°í™” ì‹œ ì• ë‹ˆë©”ì´ì…˜ ë¹„í™œì„±í™”
  simulators.simulator.optionValues = pickUniqueOptions([], false);
  simulators.simulator80.optionValues = pickUniqueOptions([], true);
  renderOptions("simulator", false);
  renderOptions("simulator80", false);
});
</script>
</body>
</html>